<script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- CONFIGURATION & FAQ KNOWLEDGE BASE ---
        const API_KEY = "AIzaSyBsJ0q6r-CkLOMVoqq4fJNIahocoMBTBDk";
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // This is the "brain" of your assistant. Add more details here as needed.
        const systemPrompt = `
            You are the AI Medical Assistant for Dr. Nirmal Lamichhane. 
            Role: Senior Consultant Surgeon & Uro-Oncologist.
            Location: Bharatpur, Nepal.
            Clinic Phone: 056493511.
            
            KNOWLEDGE BASE (FAQ):
            1. SURGERY TYPES: Dr. Nirmal specializes in Uro-Oncology (Kidney, Bladder, Prostate cancer surgeries), Laparoscopic surgeries, and general advanced surgical procedures.
            2. CLINIC HOURS: Sunday to Friday, 10:00 AM to 5:00 PM. (Closed on Saturdays).
            3. APPOINTMENTS: Users can call 056493511 or visit the official website.
            4. BIOGRAPHY: He is a highly experienced surgeon dedicated to advanced urological and oncological care in Nepal.
            
            GUIDELINES:
            - Be professional, warm, and concise.
            - Answer in the language the user speaks (English, Nepali, or Chinese).
            - For medical emergencies, tell them to visit the Emergency Ward immediately.
            - Always mention that AI advice is not a substitute for a physical consultation.
        `;

        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            systemInstruction: systemPrompt
        });

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                back_home: "Home", name: "Dr. Nirmal Lamichhane", spec: "Senior Consultant Surgeon | Uro-Oncology",
                visit_site: "Visit Official Website", chat_ai: "Chat with Medical Assistant",
                call_clinic: "Call Clinic Appointment", email_us: "Send an Email", find_map: "Hospital Location Map",
                chat_head: "Medical Assistant",
                welcome_msg: "Namaste. I am Dr. Nirmal's Assistant. How can I help you?",
                loading: "Consulting Dr. Nirmal's schedule..."
            },
            ne: {
                back_home: "होम", name: "डा. निर्मल लामिछाने", spec: "वरिष्ठ कन्सल्टेन्ट सर्जन | युरो-अन्कोलोजी",
                visit_site: "आधिकारिक वेबसाइट", chat_ai: "मेडिकल असिस्टेन्टसँग च्याट गर्नुहोस्",
                call_clinic: "क्लिनिकमा कल गर्नुहोस्", email_us: "इमेल पठाउनुहोस्", find_map: "अस्पतालको नक्सा",
                chat_head: "मेडिकल असिस्टेन्ट",
                welcome_msg: "नमस्ते। म डा. निर्मलको सहायक हुँ। म तपाईंलाई कसरी सहयोग गर्न सक्छु?",
                loading: "डा. निर्मलको तालिका हेर्दै..."
            },
            zh: {
                back_home: "主页", name: "尼尔马尔·拉米恰内 博士", spec: "高级顾问外科医生 | 泌尿肿瘤学",
                visit_site: "访问官方网站", chat_ai: "与医疗助手聊天",
                call_clinic: "致电诊所预约", email_us: "发送电子邮件", find_map: "医院位置地图",
                chat_head: "医疗助手",
                welcome_msg: "您好，我是尼尔马尔医生的助手。请问有什么可以帮您？",
                loading: "正在查询医生的日程..."
            }
        };

        let currentLang = 'en';

        // Bind functions to window so they work with HTML onclick
        window.setLanguage = (lang) => {
            currentLang = lang;
            document.body.className = 'lang-' + lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            
            const trans = translations[lang];
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (trans[key]) el.innerText = trans[key];
            });

            document.getElementById('user-input').placeholder = 
                lang === 'ne' ? "लेख्नुहोस् वा बोल्नुहोस्..." : lang === 'zh' ? "输入或说话..." : "Type or speak...";
        };

        window.toggleChat = () => {
            const win = document.getElementById('chat-window');
            win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
            if (win.style.display === 'flex' && document.getElementById('chat-body').children.length <= 1) {
                const welcome = translations[currentLang].welcome_msg;
                document.querySelector('.bot-msg').innerText = welcome;
                speakText(welcome);
            }
        };

        window.sendMessage = async () => {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;
            
            addMessage(text, 'user-msg');
            input.value = '';
            
            const loadingMsg = addMessage(translations[currentLang].loading, 'bot-msg');

            try {
                const result = await model.generateContent(text);
                const response = await result.response;
                const aiResponseText = response.text();
                
                loadingMsg.innerText = aiResponseText;
                speakText(aiResponseText);
            } catch (error) {
                loadingMsg.innerText = "Error: Could not connect to the assistant. Please call the clinic directly.";
                console.error(error);
            }
        };

        function addMessage(text, className) {
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            div.className = 'msg ' + className;
            div.innerText = text;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
            return div;
        }

        window.startVoice = () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Voice not supported");
            
            const recognition = new SpeechRecognition();
            recognition.lang = currentLang === 'ne' ? 'ne-NP' : currentLang === 'zh' ? 'zh-CN' : 'en-US';
            
            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.add('listening');
            
            recognition.start();
            recognition.onresult = (event) => {
                document.getElementById('user-input').value = event.results[0][0].transcript;
                micBtn.classList.remove('listening');
                window.sendMessage();
            };
            recognition.onerror = () => micBtn.classList.remove('listening');
        };

        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = currentLang === 'ne' ? 'hi-IN' : currentLang === 'zh' ? 'zh-CN' : 'en-US';
            window.speechSynthesis.speak(utterance);
        }
    </script>
